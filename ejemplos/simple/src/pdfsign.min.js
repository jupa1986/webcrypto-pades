(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.pdfsign=f()}})(function(){var define,module,exports;return function(){function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}return e}()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var regeneratorRuntime=require("regenerator-runtime");var newSig=function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(webcrypto,pdf,root,rootSuccessor,date,password){var array,annotEntry,sigEntry,appendAnnot,startAnnot,append,startSig,start,crypto,middle,byteRange,end,append2,startRoot,limit,acroForm,appendAcroForm,offsetForm,offsetAcroForm,offsetSigFlags,endOffsetAcroForm,pages,contentRef,xref,startContent,xrefEntry,xrefEntrySuccessor,offsetAnnot,sha256Buffer,sha256Hex,prev,eof,buffer,ubuffer,j,i,prevStr,offsetXref,old,startxref,xrefEntries,xrefTable,from1,to1,from2,to2;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:array=insertIntoArray(new Uint8Array(0),0,"\n");annotEntry=findFreeXrefNr(pdf.xref.entries);sigEntry=findFreeXrefNr(pdf.xref.entries,[annotEntry]);appendAnnot=" "+annotEntry+" 0 R";startAnnot=array.length;append=annotEntry+" 0 obj\n<</F 132/Type/Annot/Subtype/Widget/Rect[0 0 0 0]/FT/Sig/DR<<>>/T(signature"+annotEntry+")/V "+sigEntry+" 0 R>>\nendobj\n\n";array=insertIntoArray(array,startAnnot,append);startSig=array.length;start=sigEntry+" 0 obj\n<</Contents <";crypto=new Array(round256(1024*6)).join("0");middle=">\n/Type/Sig/SubFilter/adbe.pkcs7.detached/Location()/M(D:"+now(date)+"')\n/ByteRange ";byteRange="[0000000000 0000000000 0000000000 0000000000]";end="/Filter/Adobe.PPKLite/Reason()/ContactInfo()>>\nendobj\n\n";append2=start+crypto+middle+byteRange+end;array=insertIntoArray(array,startSig,append2);startRoot=array.length;limit=root.offset==rootSuccessor.offset?find(pdf.stream.bytes,"endobj",root.offset)+7:rootSuccessor.offset;array=copyTo(array,pdf.stream.bytes,root.offset,limit);array=insertIntoArray(array,array.length,"\n");acroForm=pdf.xref.root.get("AcroForm");if(!(typeof acroForm==="undefined")){_context.next=26;break}appendAcroForm="/AcroForm<</Fields["+appendAnnot+"] /SigFlags 3>>";offsetForm=find(array,"<<",startRoot)+2;array=insertIntoArray(array,offsetForm,appendAcroForm);_context.next=37;break;case 26:if(!(acroForm.objId==null)){_context.next=36;break}offsetAcroForm=find(array,"/AcroForm",startRoot);offsetAcroForm=find(array,"/Fields",offsetAcroForm);offsetSigFlags=find(array,"SigFlags",offsetAcroForm);endOffsetAcroForm=find(array,"]",offsetAcroForm);if(!(offsetSigFlags<0)){_context.next=33;break}throw new Error("PDF no soportado!");case 33:array=insertIntoArray(array,endOffsetAcroForm,appendAnnot);_context.next=37;break;case 36:throw new Error("PDF no soportado!");case 37:pages=pdf.catalog.catDict.get("Pages");contentRef=pages.get("Kids")[0];xref=pdf.xref.fetch(contentRef);if(xref.get("Kids")!=undefined){contentRef=xref.get("Kids")[0]}startContent=array.length;xrefEntry=pdf.xref.getEntry(contentRef.num);xrefEntrySuccessor=findSuccessorEntry(pdf.xref.entries,xrefEntry);limit=xrefEntry.offset===xrefEntrySuccessor.offset?find(pdf.stream.bytes,"endobj",xrefEntry.offset)+7:xrefEntrySuccessor.offset;array=copyTo(array,pdf.stream.bytes,xrefEntry.offset,limit);offsetAnnot=find(array,"/Annots",startContent);if(offsetAnnot<0){offsetAnnot=find(array,"<<",startContent)+2;appendAnnot="/Annots["+appendAnnot+"]\n"}else{offsetAnnot=find(array,"]",offsetAnnot)}array=insertIntoArray(array,offsetAnnot,appendAnnot);_context.next=51;return webcrypto.subtle.digest("SHA-256",array);case 51:sha256Buffer=_context.sent;sha256Hex=(0,_pvutils.bufferToHexCodes)(sha256Buffer);prev=findBackwards(pdf.stream.bytes,"startxref",pdf.stream.bytes.length-1);eof=find(pdf.stream.bytes,"%%EOF",prev);buffer=new ArrayBuffer(eof-prev);ubuffer=new Uint8Array(buffer);j=0;for(i=prev;i<eof;i++){ubuffer[j++]=pdf.stream.bytes[i]}prevStr=String.fromCharCode.apply(null,ubuffer);offsetXref=parseInt(prevStr.match(/\d+/)[0]);if(!(find(pdf.stream.bytes,"xref",offsetXref,offsetXref+7)<0)){_context.next=63;break}throw new Error("PDF no soportado!");case 63:prev=offsetXref;array=insertIntoArray(pdf.stream.bytes,pdf.stream.bytes.length,array);old=pdf.stream.bytes.length;startxref=array.length;xrefEntries=[];xrefEntries[0]={offset:0,gen:65535,free:true};xrefEntries[pdf.xref.topDict.getRaw("Root").num]={offset:startRoot+old,gen:0,free:false};xrefEntries[contentRef.num]={offset:startContent+old,gen:0,free:false};xrefEntries[annotEntry]={offset:startAnnot+old,gen:0,free:false};xrefEntries[sigEntry]={offset:startSig+old,gen:0,free:false};xrefTable=createXrefTableAppend(xrefEntries);xrefTable+=createTrailer(pdf.xref.topDict,startxref,sha256Hex,xrefEntries.length,prev);array=insertIntoArray(array,array.length,xrefTable);from1=0;to1=startSig+start.length+old;from2=to1+crypto.length;to2=array.length-from2-1;byteRange="["+pad10(from1)+" "+pad10(to1-1)+" "+pad10(from2+1)+" "+pad10(to2)+"]";array=updateArray(array,from2+middle.length,byteRange);return _context.abrupt("return",[array,[from1,to1-1,from2+1,to2]]);case 83:case"end":return _context.stop()}}},_callee,this)}));return function newSig(_x,_x2,_x3,_x4,_x5,_x6){return _ref.apply(this,arguments)}}();var newSig2=function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(webcrypto,pdf,root,rootSuccessor,date,password){var startRoot,annotEntry,sigEntry,appendAnnot,limit,acroForm,array,appendAcroForm,offsetForm,offsetAcroForm,offsetSigFlags,endOffsetAcroForm,objId,_xrefEntry,xrefEntrySuccessor,offsetFields,endOffsetFields,pages,contentRef,xref,xrefEntry,startContent,offsetAnnot,subAnnots,offsetAnnotEnd,offsetAnnotPartial,_buffer,_ubuffer,_j,i,_prevStr,xrefOffset,startAnnot,append,startSig,start,crypto,middle,byteRange,end,append2,sha256Buffer,sha256Hex,prev,eof,buffer,ubuffer,j,_i,prevStr,startxref,xrefEntries,xrefTable,from1,to1,from2,to2;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:startRoot=pdf.stream.bytes.length+1;annotEntry=findFreeXrefNr(pdf.xref.entries);sigEntry=findFreeXrefNr(pdf.xref.entries,[annotEntry]);appendAnnot=" "+annotEntry+" 0 R";if(root.offset==rootSuccessor.offset)limit=find(pdf.stream.bytes,"endobj",root.offset)+7;else limit=rootSuccessor.offset;acroForm=pdf.xref.root.get("AcroForm");if(!(typeof acroForm==="undefined")){_context2.next=13;break}array=copyToEnd(pdf.stream.bytes,root.offset-1,limit);appendAcroForm="/AcroForm<</Fields["+appendAnnot+"] /SigFlags 3>>";offsetForm=find(array,"<<",startRoot)+2;array=insertIntoArray(array,offsetForm,appendAcroForm);_context2.next=36;break;case 13:array=copyToEnd(pdf.stream.bytes,root.offset-1,limit);if(!(acroForm.objId==null)){_context2.next=23;break}offsetAcroForm=find(array,"/AcroForm",startRoot);offsetAcroForm=find(array,"/Fields",offsetAcroForm);offsetSigFlags=find(array,"SigFlags",offsetFields);endOffsetAcroForm=find(array,"]",offsetAcroForm);if(offsetSigFlags<0){array=insertIntoArray(array,endOffsetAcroForm+1,"/SigFlags 3")}array=insertIntoArray(array,endOffsetAcroForm,appendAnnot);_context2.next=36;break;case 23:if(!(acroForm.objId!=null)){_context2.next=35;break}objId=acroForm.objId.substring(0,acroForm.objId.length-1);_xrefEntry=pdf.xref.getEntry(objId);if(!(typeof _xrefEntry.uncompressed=="undefined")){_context2.next=28;break}throw new Error("PDF no soportado!");case 28:xrefEntrySuccessor=findSuccessorEntry(pdf.xref.entries,_xrefEntry);array=copyToEnd(array,_xrefEntry.offset-1,xrefEntrySuccessor.offset);offsetFields=find(array,"/Fields",startRoot);endOffsetFields=find(array,"]",offsetFields);offsetSigFlags=find(array,"SigFlags",offsetFields);if(offsetSigFlags<0){array=insertIntoArray(array,endOffsetFields+1,"/SigFlags 3")}array=insertIntoArray(array,endOffsetFields,appendAnnot);case 35:throw new Error("PDF no soportado!");case 36:pages=pdf.catalog.catDict.get("Pages");contentRef=pages.get("Kids")[0];xref=pdf.xref.fetch(contentRef);if(xref.get("Kids")!=undefined){contentRef=xref.get("Kids")[0]}xrefEntry=pdf.xref.getEntry(contentRef.num);if(!(typeof xrefEntry.uncompressed=="undefined")){_context2.next=43;break}throw new Error("PDF no soportado!");case 43:xrefEntrySuccessor=findSuccessorEntry(pdf.xref.entries,xrefEntry);startContent=array.length;offsetAnnot=find(array,"/Annots",xrefEntry.offset,xrefEntrySuccessor.offset);subAnnots=false;if(!(offsetAnnot>0)){_context2.next=63;break}offsetAnnot+=7;offsetAnnotEnd=find(array,"/",offsetAnnot,xrefEntrySuccessor.offset);if(offsetAnnotEnd<0)offsetAnnotEnd=find(array,">>",offsetAnnot,xrefEntrySuccessor.offset);offsetAnnotPartial=find(array,"]",offsetAnnot,offsetAnnotEnd);if(!(offsetAnnotPartial<0)){_context2.next=63;break}_buffer=new ArrayBuffer(offsetAnnotEnd-offsetAnnot);_ubuffer=new Uint8Array(_buffer);_j=0;for(i=offsetAnnot;i<offsetAnnotEnd;i++){_ubuffer[_j++]=array[i]}_prevStr=String.fromCharCode.apply(null,_ubuffer);xrefOffset=parseInt(_prevStr.match(/\d+/)[0]);xrefEntry=pdf.xref.getEntry(xrefOffset);xrefEntrySuccessor=findSuccessorEntry(pdf.xref.entries,xrefEntry);subAnnots=true;throw new Error("PDF no soportado!");case 63:array=copyToEnd(array,xrefEntry.offset,xrefEntrySuccessor.offset);offsetAnnot=find(array,"/Annots",startContent);if(offsetAnnot<0&&!subAnnots){offsetAnnot=find(array,"<<",startContent)+2;appendAnnot="/Annots["+appendAnnot+"]\n "}else{if(subAnnots)offsetAnnot=find(array,"]",startContent);else offsetAnnot=find(array,"]",offsetAnnot)}array=insertIntoArray(array,offsetAnnot,appendAnnot);startAnnot=array.length;append=annotEntry+" 0 obj\n<</F 132/Type/Annot/Subtype/Widget/Rect[0 0 0 0]/FT/Sig/DR<<>>/T(signature"+annotEntry+")/V "+sigEntry+" 0 R>>\nendobj\n\n";array=insertIntoArray(array,startAnnot,append);startSig=array.length;start=sigEntry+" 0 obj\n<</Contents <";crypto=new Array(round256(1024*6)).join("0");middle=">\n/Type/Sig/SubFilter/adbe.pkcs7.detached/Location()/M(D:"+now(date)+"')\n/ByteRange ";byteRange="[0000000000 0000000000 0000000000 0000000000]";end="/Filter/Adobe.PPKLite/Reason()/ContactInfo()>>\nendobj\n\n";append2=start+crypto+middle+byteRange+end;array=insertIntoArray(array,startSig,append2);_context2.next=80;return webcrypto.subtle.digest("SHA-256",array);case 80:sha256Buffer=_context2.sent;sha256Hex=(0,_pvutils.bufferToHexCodes)(sha256Buffer);prev=findBackwards(array,"startxref",array.length-1);eof=find(array,"%%EOF",prev);buffer=new ArrayBuffer(eof-prev);ubuffer=new Uint8Array(buffer);j=0;for(_i=prev;_i<eof;_i++){ubuffer[j++]=array[_i]}prevStr=String.fromCharCode.apply(null,ubuffer);xrefOffset=parseInt(prevStr.match(/\d+/)[0]);if(!(find(array,"xref",xrefOffset,xrefOffset+7)<0)){_context2.next=92;break}throw new Error("PDF no soportado!");case 92:prev=xrefOffset;startxref=array.length;xrefEntries=[];xrefEntries[0]={offset:0,gen:65535,free:true};xrefEntries[pdf.xref.topDict.getRaw("Root").num]={offset:startRoot,gen:0,free:false};xrefEntries[contentRef.num]={offset:startContent,gen:0,free:false};xrefEntries[annotEntry]={offset:startAnnot,gen:0,free:false};xrefEntries[sigEntry]={offset:startSig,gen:0,free:false};xrefTable=createXrefTableAppend(xrefEntries);xrefTable+=createTrailer(pdf.xref.topDict,startxref,sha256Hex,xrefEntries.length,prev);array=insertIntoArray(array,array.length,xrefTable);from1=0;to1=startSig+start.length;from2=to1+crypto.length;to2=array.length-from2-1;byteRange="["+pad10(from1)+" "+pad10(to1-1)+" "+pad10(from2+1)+" "+pad10(to2)+"]";array=updateArray(array,from2+middle.length,byteRange);return _context2.abrupt("return",[array,[from1,to1-1,from2+1,to2]]);case 110:case"end":return _context2.stop()}}},_callee2,this)}));return function newSig2(_x7,_x8,_x9,_x10,_x11,_x12){return _ref2.apply(this,arguments)}}();exports.removeFromArray=removeFromArray;exports.updateArray=updateArray;exports.insertIntoArray=insertIntoArray;exports.signpdfEmpty=signpdfEmpty;exports.parsePDF=parsePDF;exports.setPDFDocument=setPDFDocument;var _pvutils=require("pvutils");function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step("next",value)},function(err){step("throw",err)})}}return step("next")})}}var PDFDocument=void 0;function createXrefTable(xrefEntries){xrefEntries=sortOnKeys(xrefEntries);var retVal="xref\n";var last=-2;for(var i in xrefEntries){i=parseInt(i);if(typeof xrefEntries[i].offset==="undefined"){continue}retVal+=calcFlow(i,last,xrefEntries);var offset=xrefEntries[i].offset;retVal+=pad10(offset)+" "+pad5(xrefEntries[i].gen)+" "+(xrefEntries[i].free?"f":"n")+" \n";last=i}return retVal}function calcFlow(i,last,xrefEntries){if(last+1===i){return""}var count=1;while(typeof xrefEntries[i+count]!=="undefined"&&typeof xrefEntries[i+count].offset!=="undefined"){count++}return i+" "+count+"\n"}function createTrailer(topDict,startxref,sha256Hex,size,prev){var retVal="trailer <<\n";retVal+="  /Size "+size+"\n";var refRoot=topDict.getRaw("Root");if(typeof refRoot!=="undefined"){retVal+="  /Root "+refRoot.num+" "+refRoot.gen+" R\n"}var refInfo=topDict.getRaw("Info");if(typeof refInfo!=="undefined"){retVal+="  /Info "+refInfo.num+" "+refInfo.gen+" R\n"}retVal+="  /ID [<"+sha256Hex.substring(0,32)+"><"+sha256Hex.substring(32,64)+">]\n";if(typeof prev!=="undefined"){retVal+="  /Prev "+prev+"\n"}retVal+=">>\n";retVal+="startxref\n";retVal+=startxref+"\n";retVal+="%%EOF\n";return retVal}function createXrefTableAppend(xrefEntries){xrefEntries=sortOnKeys(xrefEntries);var retVal="xref\n";var last=-2;for(var i in xrefEntries){i=parseInt(i);if(typeof xrefEntries[i].offset==="undefined"){continue}retVal+=calcFlow(i,last,xrefEntries);var offset=xrefEntries[i].offset;retVal+=pad10(offset)+" "+pad5(xrefEntries[i].gen)+" "+(xrefEntries[i].free?"f":"n")+" \n";last=i}return retVal}function sortOnKeys(dict){var sorted=[];for(var key in dict){sorted[sorted.length]=key}sorted.sort();var tempDict={};for(var i=0;i<sorted.length;i++){tempDict[sorted[i]]=dict[sorted[i]]}return tempDict}function removeFromArray(array,from,to){var cutlen=to-from;var buf=new Uint8Array(array.length-cutlen);for(var i=0;i<from;i++){buf[i]=array[i]}for(var i=to,len=array.length;i<len;i++){buf[i-cutlen]=array[i]}return buf}function pad10(num){var s="000000000"+num;return s.substr(s.length-10)}function pad5(num){var s="0000"+num;return s.substr(s.length-5)}function pad2(num){var s="0"+num;return s.substr(s.length-2)}function findRootEntry(xref){var rootNr=xref.root.objId.substring(0,xref.root.objId.length-1);return xref.entries[rootNr]}function findSuccessorEntry(xrefEntries,current){var currentOffset=current.offset;var currentMin=Number.MAX_SAFE_INTEGER;var currentMinIndex=-1;for(var i in xrefEntries){if(typeof xrefEntries[i].uncompressed!="boolean")continue;if(xrefEntries[i].offset>currentOffset){if(xrefEntries[i].offset<currentMin){currentMin=xrefEntries[i].offset;currentMinIndex=i}}}if(currentMinIndex===-1){return current}return xrefEntries[currentMinIndex]}function updateArray(array,pos,str){var upd=stringToUint8Array(str);for(var i=0,len=upd.length;i<len;i++){array[i+pos]=upd[i]}return array}function copyToEnd(array,from,to){var buf=new Uint8Array(array.length+(to-from));for(var i=0,len=array.length;i<len;i++){buf[i]=array[i]}for(var i=0,len=to-from;i<len;i++){buf[array.length+i]=array[from+i]}return buf}function copyTo(array0,array,from,to){var buf=new Uint8Array(array0.length+(to-from));for(var i=0,len=array0.length;i<len;i++){buf[i]=array0[i]}for(var i=0,len=to-from;i<len;i++){buf[array0.length+i]=array[from+i]}return buf}function insertIntoArray(array,pos,str){var ins=str instanceof Uint8Array?str:stringToUint8Array(str);var buf=new Uint8Array(array.length+ins.length);for(var i=0;i<pos;i++){buf[i]=array[i]}for(var i=0;i<ins.length;i++){buf[pos+i]=ins[i]}for(var i=pos;i<array.length;i++){buf[ins.length+i]=array[i]}return buf}function stringToUint8Array(str){var buf=new Uint8Array(str.length);for(var i=0,strLen=str.length;i<strLen;i++){buf[i]=str.charCodeAt(i)}return buf}function findFreeXrefNr(xrefEntries,used){used=typeof used!=="undefined"?used:[];var inc=used.length;for(var i=1;i<xrefEntries.length;i++){var index=used.indexOf(i);var entry=xrefEntries[""+i];if(index===-1&&(typeof entry==="undefined"||entry.free)){return i}if(index!==-1){inc--}}return xrefEntries.length+inc}function find(uint8,needle,start,limit){start=typeof start!=="undefined"?start:0;limit=typeof limit!=="undefined"?limit:Number.MAX_SAFE_INTEGER;var search=stringToUint8Array(needle);var match=0;for(var i=start;i<uint8.length&&i<limit;i++){if(uint8[i]===search[match]){match++}else{match=0;if(uint8[i]===search[match]){match++}}if(match===search.length){return i+1-match}}return-1}function findBackwards(uint8,needle,start,limit){start=typeof start!=="undefined"?start:uint8.length;limit=typeof limit!=="undefined"?limit:Number.MAX_SAFE_INTEGER;var search=stringToUint8Array(needle);var match=search.length-1;for(var i=start;i>=0&&i<limit;i--){if(uint8[i]===search[match]){match--}else{match=search.length-1;if(uint8[i]===search[match]){match--}}if(match===0){return i-1}}return-1}function isSigInRoot(pdf){if(typeof pdf.acroForm==="undefined"){return false}return pdf.acroForm.get("SigFlags")===3}function round256(x){return Math.ceil(x/256)*256-1}function now(date){date=typeof date!=="undefined"?date:new Date;var yyyy=date.getFullYear().toString();var MM=pad2(date.getMonth()+1);var dd=pad2(date.getDate());var hh=pad2(date.getHours());var mm=pad2(date.getMinutes());var ss=pad2(date.getSeconds());return yyyy+MM+dd+hh+mm+ss+createOffset(date)}function createOffset(date){var sign=date.getTimezoneOffset()>0?"-":"+";var offset=Math.abs(date.getTimezoneOffset());var hours=pad2(Math.floor(offset/60));var minutes=pad2(offset%60);return sign+hours+"'"+minutes}function signpdfEmpty(pdfRaw,crypto){var date=new Date;var pdf=parsePDF(pdfRaw);var root=findRootEntry(pdf.xref);if(typeof root.uncompressed=="undefined")throw new Error("PDF no soportado!");var rootSuccessor=findSuccessorEntry(pdf.xref.entries,root);return newSig(crypto,pdf,root,rootSuccessor,date)}function parsePDF(pdfRaw){if(pdfRaw instanceof ArrayBuffer)pdfRaw=new Uint8Array(pdfRaw);var pdf=new PDFDocument({evaluatorOptions:{}},pdfRaw);try{pdf.parseStartXRef();pdf.parse()}catch(err){throw new Error("PDF no soportado!")}return pdf}function setPDFDocument(_PDFDocument){PDFDocument=_PDFDocument}},{pvutils:"pvutils","regenerator-runtime":3}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.listSignatures=undefined;var regeneratorRuntime=require("regenerator-runtime");var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var createOCSPReq=function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(serialNumbers){var extension,issuerKeyHash,issuerNameHash,ocspReq,requestList;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(serialNumbers instanceof Array))serialNumbers=[serialNumbers];extension=CA.extensions.find(function(extension){return extension.extnID=="2.5.29.14"});issuerKeyHash=extension.parsedValue.valueBlock.valueHex;_context2.next=5;return pkijs.getCrypto().subtle.digest("SHA-1",CA.subject.valueBeforeDecode);case 5:issuerNameHash=_context2.sent;ocspReq=new pkijs.OCSPRequest;requestList=[];serialNumbers.forEach(function(serialNumber){requestList.push(new pkijs.Request({reqCert:new pkijs.CertID({hashAlgorithm:new pkijs.AlgorithmIdentifier({algorithmId:"1.3.14.3.2.26"}),issuerNameHash:new asn1js.OctetString({valueHex:issuerNameHash}),issuerKeyHash:new asn1js.OctetString({valueHex:issuerKeyHash}),serialNumber:new asn1js.Integer({valueHex:serialNumber})})}))});ocspReq.tbsRequest.requestList=requestList;return _context2.abrupt("return",ocspReq);case 11:case"end":return _context2.stop()}}},_callee2,this)}));return function createOCSPReq(_x2){return _ref4.apply(this,arguments)}}();var listSignatures=exports.listSignatures=function(){var _ref5=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(pdf,ocspReq){var result,sigFields,serialNumbers,i,data,sigField,v,byteRange,contents,contentBuffer,asn1,cmsContentSimp,cmsSignedSimp,certificate,subFilter,filter,date,pattern,signedDataBuffer,ocspReqBuffer,ocspResult,statusCode,ocspResBuffer,_asn,ocspRespSimpl,ocspBasicResp,asn1Basic,_loop,_i;return regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:result={data:[]};pdf=pdfsign.parsePDF(pdf);sigFields=listSigFields(pdf);serialNumbers=[];_context3.t0=regeneratorRuntime.keys(sigFields);case 5:if((_context3.t1=_context3.t0()).done){_context3.next=38;break}i=_context3.t1.value;data={};sigField=sigFields[i];v=sigField.get("V");byteRange=v.get("ByteRange");contents=v.get("Contents");contentBuffer=pvutils.stringToArrayBuffer(contents);asn1=asn1js.fromBER(contentBuffer);cmsContentSimp=new pkijs.ContentInfo({schema:asn1.result});cmsSignedSimp=new pkijs.SignedData({schema:cmsContentSimp.content});certificate=cmsSignedSimp.certificates[0];data.serialNumber=pvutils.bufferToHexCodes(certificate.serialNumber.valueBlock.valueHex);serialNumbers.push(certificate.serialNumber.valueBlock.valueHex);subFilter=v.get("SubFilter");filter=v.get("Filter");data.subFilter=subFilter.name.toUpperCase();date=v.get("M");pattern=/D:(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})-0(\d{1})'00'/;if(date!=undefined)data.signedDate=date.replace(pattern,"$3/$2/$1 $4:$5:$6");signedDataBuffer=pdfsign.removeFromArray(pdf.stream.bytes,byteRange[1],byteRange[2]);signedDataBuffer=pdfsign.removeFromArray(signedDataBuffer,byteRange[1]+byteRange[3],signedDataBuffer.length);_context3.next=29;return cmsSignedSimp.verify({signer:0,data:signedDataBuffer,trustedCertificates:trustedCertificates});case 29:data.modified=!_context3.sent;_context3.next=32;return certificate.verify(trustedCertificates[0]);case 32:data.trusted=_context3.sent;data.certificate=certificate;data.ocsp_status=2;result.data.push(data);_context3.next=5;break;case 38:_context3.next=40;return createOCSPReq(serialNumbers);case 40:ocspReqBuffer=_context3.sent.toSchema(true).toBER(false);if(!(ocspReq!=undefined&&typeof ocspReq=="function")){_context3.next=57;break}_context3.prev=42;_context3.next=45;return ocspReq(ocspReqBuffer);case 45:ocspResult=_context3.sent;statusCode=ocspResult[0];ocspResBuffer=ocspResult[1];_asn=asn1js.fromBER(ocspResBuffer);ocspRespSimpl=new pkijs.OCSPResponse({schema:_asn.result});ocspBasicResp=void 0;if(ocspRespSimpl.responseStatus.valueBlock.valueDec==0){if("responseBytes"in ocspRespSimpl){asn1Basic=asn1js.fromBER(ocspRespSimpl.responseBytes.response.valueBlock.valueHex);ocspBasicResp=new pkijs.BasicOCSPResponse({schema:asn1Basic.result});if(serialNumbers.length!=ocspBasicResp.tbsResponseData.responses.length){}_loop=function _loop(_i){var typeval=pvutils.bufferToHexCodes(ocspBasicResp.tbsResponseData.responses[_i].certID.serialNumber.valueBlock.valueHex);var subjval=ocspBasicResp.tbsResponseData.responses[_i].certStatus.idBlock.tagNumber;var data=result.data.find(function(data){return data.serialNumber==typeval});if(data)data.ocsp_status=subjval;if(subjval==1){data.ocsp_revokedDate=ocspBasicResp.tbsResponseData.responses[_i].certStatus.valueBlock.value[0].toDate()}data.ocsp_update=ocspBasicResp.tbsResponseData.responses[_i].thisUpdate};for(_i=0;_i<ocspBasicResp.tbsResponseData.responses.length;_i++){_loop(_i)}}else{}}_context3.next=57;break;case 54:_context3.prev=54;_context3.t2=_context3["catch"](42);console.log("OCSP no disponible:",_context3.t2);case 57:return _context3.abrupt("return",result);case 58:case"end":return _context3.stop()}}},_callee3,this,[[42,54]])}));return function listSignatures(_x3,_x4){return _ref5.apply(this,arguments)}}();exports.certificateRaw=certificateRaw;exports.keyFromCertificateId=keyFromCertificateId;exports.firstProvider=firstProvider;exports.listProviders=listProviders;exports.listCertificates=listCertificates;exports.createCMSSigned=createCMSSigned;exports.pdfHash=pdfHash;exports.issuerCertificate=issuerCertificate;exports.signpdf=signpdf;exports.firstCertificate=firstCertificate;exports.setEngine=setEngine;var _pkijs=require("pkijs");var pkijs=_interopRequireWildcard(_pkijs);var _asn1js=require("asn1js");var asn1js=_interopRequireWildcard(_asn1js);var _pvutils=require("pvutils");var pvutils=_interopRequireWildcard(_pvutils);var _pdfsign=require("./pdfsign.js");var pdfsign=_interopRequireWildcard(_pdfsign);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step("next",value)},function(err){step("throw",err)})}}return step("next")})}}var trustedCertificates=[];var CA64="MIIGlzCCBH+gAwIBAgIIDVNUG1JQENowDQYJKoZIhvcNAQELBQAwSzEuMCwGA1UEAwwlRW50aWRhZCBDZXJ0aWZpY2Fkb3JhIFJhaXogZGUgQm9saXZpYTEMMAoGA1UECgwDQVRUMQswCQYDVQQGEwJCTzAeFw0xNjA0MDgxOTU0MDlaFw0yNjA0MDkxOTU0MDlaMEsxLDAqBgNVBAMMI0VudGlkYWQgQ2VydGlmaWNhZG9yYSBQdWJsaWNhIEFEU0lCMQ4wDAYDVQQKDAVBRFNJQjELMAkGA1UEBhMCQk8wggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQDIQGzLQDJP3JGZP8jtFxp3iMliw4yhx3b6n53e4Qqo8p229UqI5nuDxSY/sxpH6SZGCpbu+33wGhI/5MHrLZEW1GJ/UTNkRhbtJhhcWkYXovRp9MQ9HW14vIatjXJLzXErKGqsmTBPd9M56IYOoskh5i+6wn+kofBpDqSeoMP5bh3GdH6q+D34KjuTPclnDLlztspTQa4p0VxRkdzBekPRghU3D7RbtYycGgRrfwoRrxRol+9L+Wk1VYQ3rtAKwc2A2lm2FqX1LbKaI3RUpzyvNL/9mSRt9bdTx4CryQQRKD8MqbBB1sQRXgjAx3ACan9wTCt8ck1gBdDzALFX7w/GwZiScsbjcu0+2ZZyfqxCzmkWqysoZ/qgNbHD0HCADDaxOgONxiL1jkU2ATejuM3rkLPoojydKBO0/d7cLSguYJeesZIONhlPzMGfINNsPplSPSdNLdtYpD+xDmviagdm4/m7oAIFarMOudD3PPCTHfGM4ZIFM4+/GI9JqqgYyD1kRlsPWETCT+rexrQ+snxnYgA2JxH7CJWRpjT2LWB8Fznv2c9r91wPQ0avmodusP7c1FprA6GQO+nmmuCKXuU+ts6sPFuQIeKunpEy0nEFYukvtLwOsT0gPSt5RgfmC80nLFt1yJNqbGOrAPDbvXJFjMXQbPlfZ/WjS4lsW3wUkwIDAQABo4IBfTCCAXkwQwYIKwYBBQUHAQEENzA1MDMGCCsGAQUFBzAChidodHRwczovL2VjcmIuYXR0LmdvYi5iby9lY3JiLmNhY2VydC5wZW0wHQYDVR0OBBYEFNKZ3cFvJS4nqAvr3NnWkltiVaDCMA8GA1UdEwQIMAYBAf8CAQAwHwYDVR0jBBgwFoAUoL9bVHaFJic5r9T5yu37yHC4jBYwTAYDVR0gBEUwQzBBBg1gRAAAAAEOAQIAAAAAMDAwLgYIKwYBBQUHAgEWImh0dHBzOi8vZWNyYi5hdHQuZ29iLmJvL3BjZWNyYi5wZGYwgYUGA1UdHwR+MHwweqAnoCWGI2h0dHBzOi8vZWNyYi5hdHQuZ29iLmJvL2NybGVjcmIuY3Jsok+kTTBLMS4wLAYDVQQDDCVFbnRpZGFkIENlcnRpZmljYWRvcmEgUmFpeiBkZSBCb2xpdmlhMQwwCgYDVQQKDANBVFQxCzAJBgNVBAYTAkJPMAsGA1UdDwQEAwIBBjANBgkqhkiG9w0BAQsFAAOCAgEAVdEINfGVBN5w1YMKcayKgxuX56IEhw2yjGDehKjvA8nOVoCM1j7WW3SwlOO29CpTfAHUmNJRvqdMTlUus9pYyw5BERapEoE9ZQpEmorGj8FbJjCs4hTgc67TQ0KJVWPbnMsu5wobCmv4hq/PZDr2daXA9bFNyvbNcjpea4mVC8WG5lqdflXeI6CHK91GMpw4UGSPqR7rrQj1VUqElyAAzN4PUXW83odDq6pRF7MNKr4LeI8xVL3pvLHAxrrq7dDRG807FzYjXpgKcLrExkNtZPGe4tLI1cvaxVffaPgoYyI5nbjHQDnJhCdrrugAC9xxNq1t17yO0S8wFwgs9JWcIU/8ScE54ht9cz0VneAj6yZGUziwGVRYFwhOMUtrzDdeNZW3+yhzUVasU2EZTa5z+/EWHLZDvrjWTMcyMHETquDtj/lCQHlQGzUwu+DwKedxssIVxDO/voO9wrnllqoiN8OwbSN1/LledKCtYD4h6U3M74NOcvudegeshPjdKGTYAz39jsEX+qx+kOQuMzeisYv0E7aXzkpyxZIVfOP9TWspof+K0whcEGsKwaBSu7x8sxV2rFqbF59KNSgE5RSMCXGb5QPuh0NlZ0oh8QaUrPMhNA03kzRMerMWWx94ymJ7AvUdOxg03I7WJGPTlAbJRXXL07PkIFhe04ow7MCS8Bc=";var asn2=asn1js.fromBER(pvutils.stringToArrayBuffer(pvutils.fromBase64(CA64)));var CA=new pkijs.Certificate({schema:asn2.result});trustedCertificates.push(CA);var hashAlg="SHA-256";function certificateRaw(provider,certID){return Promise.resolve().then(function(){return provider.certStorage.getItem(certID).then(function(cert){return provider.certStorage.exportCert("raw",cert).then(function(raw){return raw})})})}function keyFromCertificateId(type,provider,certID){return Promise.resolve().then(function(){return provider.keyStorage.keys()}).then(function(keyIDs){for(var i=0;i<keyIDs.length;i++){var keyID=keyIDs[i];var parts=keyID.split("-");if(parts[0]===type&&parts[2]===certID.split("-")[2]){return provider.keyStorage.getItem(keyID)}}return null}).then(function(key){if(key||type!=="public"){return key}return provider.certStorage.getItem(certID).then(function(cert){return cert.publicKey})})}function firstProvider(ws){return listProviders(ws).then(function(providers){if(providers.length>0)return ws.getCrypto(providers[0]);else throw new Error("Tokens no encontrados")})}function listProviders(ws){return ws.info().then(function(info){var providers=[];for(var i=0;i<info.providers.length;i++){var provider=info.providers[i];if(provider.isHardware)providers.push(provider.id)}return providers})}function listCertificates(provider){var certIDs=void 0,keyIDs=void 0;return Promise.resolve().then(function(){if(typeof provider.isLoggedIn=="function"){return provider.isLoggedIn().then(function(ok){if(ok)return provider.logout()}).then(function(){return provider.login()})}}).then(function(){return provider.certStorage.keys()}).then(function(indexes){certIDs=indexes.filter(function(id){var parts=id.split("-");return parts[0]==="x509"})}).then(function(){return provider.keyStorage.keys()}).then(function(indexes){keyIDs=indexes.filter(function(id){var parts=id.split("-");return parts[0]==="private"})}).then(function(){var certificates=[];for(var i=0;i<certIDs.length;i++){var certID=certIDs[i];for(var j=0;j<keyIDs.length;j++){var keyID=keyIDs[j];if(keyID.split("-")[2]===certID.split("-")[2]){certificates.push(certID);break}}}return certificates})}function createCMSSigned(hash,certSimpl,key){var signedAttr=[];signedAttr.push(new pkijs.Attribute({type:"1.2.840.113549.1.9.3",values:[new asn1js.ObjectIdentifier({value:"1.2.840.113549.1.7.1"})]}));signedAttr.push(new pkijs.Attribute({type:"1.2.840.113549.1.9.4",values:[new asn1js.OctetString({valueHex:hash})]}));var cmsSignedSimpl=new pkijs.SignedData({version:1,encapContentInfo:new pkijs.EncapsulatedContentInfo({eContentType:"1.2.840.113549.1.7.1"}),digestAlgorithms:[],signerInfos:[new pkijs.SignerInfo({version:1,sid:new pkijs.IssuerAndSerialNumber({issuer:certSimpl.issuer,serialNumber:certSimpl.serialNumber})})],certificates:[certSimpl]});cmsSignedSimpl.signerInfos[0].signedAttrs=new pkijs.SignedAndUnsignedAttributes({type:0,attributes:signedAttr});return cmsSignedSimpl.sign(key,0,hashAlg).then(function(){var cmsSignedSchema=cmsSignedSimpl.toSchema(true);var cmsContentSimp=new pkijs.ContentInfo({contentType:"1.2.840.113549.1.7.2",content:cmsSignedSchema});var _cmsSignedSchema=cmsContentSimp.toSchema(true);_cmsSignedSchema.lenBlock.isIndefiniteForm=true;var block1=_cmsSignedSchema.valueBlock.value[1];block1.lenBlock.isIndefiniteForm=true;var block2=block1.valueBlock.value[0];block2.lenBlock.isIndefiniteForm=true;var cmsSignedBuffer=_cmsSignedSchema.toBER(false);var cmsSignedHex=pvutils.bufferToHexCodes(cmsSignedBuffer);return cmsSignedHex})}function pdfHash(pdfRaw,byteRange){var data=pdfsign.removeFromArray(pdfRaw,byteRange[1],byteRange[2]);return pkijs.getEngine().subtle.digest(hashAlg,data)}function issuerCertificate(){return CA}function signpdf(pdfRaw,key,certificate){var _this=this;return pdfsign.signpdfEmpty(pdfRaw,pkijs.getEngine()).then(function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee(_ref){var _ref3=_slicedToArray(_ref,2),pdf=_ref3[0],byteRange=_ref3[1];var hash;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return pdfHash(pdf,byteRange);case 2:hash=_context.sent;return _context.abrupt("return",createCMSSigned(hash,certificate,key).then(function(signature){return pdfsign.updateArray(pdf,byteRange[1]+1,signature)}));case 4:case"end":return _context.stop()}}},_callee,_this)}));return function(_x){return _ref2.apply(this,arguments)}}())}function listSigFields(pdf){var sigFields=[];var acroForm=pdf.xref.root.get("AcroForm");if(typeof acroForm==="undefined")throw new Error("El PDF no tiene firmas!");var fields=acroForm.get("Fields");for(var i=0;i<fields.length;i++){var sigField=pdf.xref.fetch(fields[i]);var sigFieldType=sigField.get("FT");if(typeof sigFieldType==="undefined"||sigFieldType.name!=="Sig")continue;sigFields.push(sigField)}if(sigFields.length==0)throw new Error("El PDF no tiene firmas!");return sigFields}function firstCertificate(provider){var certRaw=void 0;var certID=void 0;return listCertificates(provider).then(function(certificates){if(certificates.length>0){certID=certificates[0];return certificateRaw(provider,certID)}else throw new Error("No hay certificados.")}).then(function(raw){certRaw=raw;return keyFromCertificateId("private",provider,certID)}).then(function(key){if(!key)throw new Error("Certificado no tiene llave privada.");var certSimpl=asn1js.fromBER(certRaw);var certificate=new pkijs.Certificate({schema:certSimpl.result});return[key,certificate]})}function setEngine(name,provider){pkijs.setEngine(name,provider,new pkijs.CryptoEngine({name:name,crypto:provider,subtle:provider.subtle}))}},{"./pdfsign.js":1,asn1js:"asn1js",pkijs:"pkijs",pvutils:"pvutils","regenerator-runtime":3}],3:[function(require,module,exports){var g=function(){return this}()||Function("return this")();var hadRuntime=g.regeneratorRuntime&&Object.getOwnPropertyNames(g).indexOf("regeneratorRuntime")>=0;var oldRuntime=hadRuntime&&g.regeneratorRuntime;g.regeneratorRuntime=undefined;module.exports=require("./runtime");if(hadRuntime){g.regeneratorRuntime=oldRuntime}else{try{delete g.regeneratorRuntime}catch(e){g.regeneratorRuntime=undefined}}},{"./runtime":4}],4:[function(require,module,exports){!function(global){"use strict";var Op=Object.prototype;var hasOwn=Op.hasOwnProperty;var undefined;var $Symbol=typeof Symbol==="function"?Symbol:{};var iteratorSymbol=$Symbol.iterator||"@@iterator";var asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator";var toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";var inModule=typeof module==="object";var runtime=global.regeneratorRuntime;if(runtime){if(inModule){module.exports=runtime}return}runtime=global.regeneratorRuntime=inModule?module.exports:{};function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator;var generator=Object.create(protoGenerator.prototype);var context=new Context(tryLocsList||[]);generator._invoke=makeInvokeMethod(innerFn,self,context);return generator}runtime.wrap=wrap;function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}var GenStateSuspendedStart="suspendedStart";var GenStateSuspendedYield="suspendedYield";var GenStateExecuting="executing";var GenStateCompleted="completed";var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};IteratorPrototype[iteratorSymbol]=function(){return this};var getProto=Object.getPrototypeOf;var NativeIteratorPrototype=getProto&&getProto(getProto(values([])));if(NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)){IteratorPrototype=NativeIteratorPrototype}var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);GeneratorFunction.prototype=Gp.constructor=GeneratorFunctionPrototype;GeneratorFunctionPrototype.constructor=GeneratorFunction;GeneratorFunctionPrototype[toStringTagSymbol]=GeneratorFunction.displayName="GeneratorFunction";function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){prototype[method]=function(arg){return this._invoke(method,arg)}})}runtime.isGeneratorFunction=function(genFun){var ctor=typeof genFun==="function"&&genFun.constructor;return ctor?ctor===GeneratorFunction||(ctor.displayName||ctor.name)==="GeneratorFunction":false};runtime.mark=function(genFun){if(Object.setPrototypeOf){Object.setPrototypeOf(genFun,GeneratorFunctionPrototype)}else{genFun.__proto__=GeneratorFunctionPrototype;if(!(toStringTagSymbol in genFun)){genFun[toStringTagSymbol]="GeneratorFunction"}}genFun.prototype=Object.create(Gp);return genFun};runtime.awrap=function(arg){return{__await:arg}};function AsyncIterator(generator){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if(record.type==="throw"){reject(record.arg)}else{var result=record.arg;var value=result.value;if(value&&typeof value==="object"&&hasOwn.call(value,"__await")){return Promise.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject)},function(err){invoke("throw",err,resolve,reject)})}return Promise.resolve(value).then(function(unwrapped){result.value=unwrapped;resolve(result)},reject)}}var previousPromise;function enqueue(method,arg){function callInvokeWithMethodAndArg(){return new Promise(function(resolve,reject){invoke(method,arg,resolve,reject)})}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}this._invoke=enqueue}defineIteratorMethods(AsyncIterator.prototype);AsyncIterator.prototype[asyncIteratorSymbol]=function(){return this};runtime.AsyncIterator=AsyncIterator;runtime.async=function(innerFn,outerFn,self,tryLocsList){var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList));return runtime.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next()})};function makeInvokeMethod(innerFn,self,context){var state=GenStateSuspendedStart;return function invoke(method,arg){if(state===GenStateExecuting){throw new Error("Generator is already running")}if(state===GenStateCompleted){if(method==="throw"){throw arg}return doneResult()}context.method=method;context.arg=arg;while(true){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if(context.method==="next"){context.sent=context._sent=context.arg}else if(context.method==="throw"){if(state===GenStateSuspendedStart){state=GenStateCompleted;throw context.arg}context.dispatchException(context.arg)}else if(context.method==="return"){context.abrupt("return",context.arg)}state=GenStateExecuting;var record=tryCatch(innerFn,self,context);if(record.type==="normal"){state=context.done?GenStateCompleted:GenStateSuspendedYield;if(record.arg===ContinueSentinel){continue}return{value:record.arg,done:context.done}}else if(record.type==="throw"){state=GenStateCompleted;context.method="throw";context.arg=record.arg}}}}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(method===undefined){context.delegate=null;if(context.method==="throw"){if(delegate.iterator.return){context.method="return";context.arg=undefined;maybeInvokeDelegate(delegate,context);if(context.method==="throw"){return ContinueSentinel}}context.method="throw";context.arg=new TypeError("The iterator does not provide a 'throw' method")}return ContinueSentinel}var record=tryCatch(method,delegate.iterator,context.arg);if(record.type==="throw"){context.method="throw";context.arg=record.arg;context.delegate=null;return ContinueSentinel}var info=record.arg;if(!info){context.method="throw";context.arg=new TypeError("iterator result is not an object");context.delegate=null;return ContinueSentinel}if(info.done){context[delegate.resultName]=info.value;context.next=delegate.nextLoc;if(context.method!=="return"){context.method="next";context.arg=undefined}}else{return info}context.delegate=null;return ContinueSentinel}defineIteratorMethods(Gp);Gp[toStringTagSymbol]="Generator";Gp[iteratorSymbol]=function(){return this};Gp.toString=function(){return"[object Generator]"};function pushTryEntry(locs){var entry={tryLoc:locs[0]};if(1 in locs){entry.catchLoc=locs[1]}if(2 in locs){entry.finallyLoc=locs[2];entry.afterLoc=locs[3]}this.tryEntries.push(entry)}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal";delete record.arg;entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}];tryLocsList.forEach(pushTryEntry,this);this.reset(true)}runtime.keys=function(object){var keys=[];for(var key in object){keys.push(key)}keys.reverse();return function next(){while(keys.length){var key=keys.pop();if(key in object){next.value=key;next.done=false;return next}}next.done=true;return next}};function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod){return iteratorMethod.call(iterable)}if(typeof iterable.next==="function"){return iterable}if(!isNaN(iterable.length)){var i=-1,next=function next(){while(++i<iterable.length){if(hasOwn.call(iterable,i)){next.value=iterable[i];next.done=false;return next}}next.value=undefined;next.done=true;return next};return next.next=next}}return{next:doneResult}}runtime.values=values;function doneResult(){return{value:undefined,done:true}}Context.prototype={constructor:Context,reset:function(skipTempReset){this.prev=0;this.next=0;this.sent=this._sent=undefined;this.done=false;this.delegate=null;this.method="next";this.arg=undefined;this.tryEntries.forEach(resetTryEntry);if(!skipTempReset){for(var name in this){if(name.charAt(0)==="t"&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))){this[name]=undefined}}}},stop:function(){this.done=true;var rootEntry=this.tryEntries[0];var rootRecord=rootEntry.completion;if(rootRecord.type==="throw"){throw rootRecord.arg}return this.rval},dispatchException:function(exception){if(this.done){throw exception}var context=this;function handle(loc,caught){record.type="throw";record.arg=exception;context.next=loc;if(caught){context.method="next";context.arg=undefined}return!!caught}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];var record=entry.completion;if(entry.tryLoc==="root"){return handle("end")}if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc");var hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}else if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else if(hasCatch){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}}else if(hasFinally){if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else{throw new Error("try statement without catch or finally")}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}if(finallyEntry&&(type==="break"||type==="continue")&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc){finallyEntry=null}var record=finallyEntry?finallyEntry.completion:{};record.type=type;record.arg=arg;if(finallyEntry){this.method="next";this.next=finallyEntry.finallyLoc;return ContinueSentinel}return this.complete(record)},complete:function(record,afterLoc){if(record.type==="throw"){throw record.arg}if(record.type==="break"||record.type==="continue"){this.next=record.arg}else if(record.type==="return"){this.rval=this.arg=record.arg;this.method="return";this.next="end"}else if(record.type==="normal"&&afterLoc){this.next=afterLoc}return ContinueSentinel},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc){this.complete(entry.completion,entry.afterLoc);resetTryEntry(entry);return ContinueSentinel}}},catch:function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if(record.type==="throw"){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc};if(this.method==="next"){this.arg=undefined}return ContinueSentinel}}}(function(){return this}()||Function("return this")())},{}],"pdfjs-firma":[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.pdfHash=exports.firstProvider=exports.firstCertificate=exports.listSignatures=exports.issuerCertificate=exports.setEngine=exports.signpdf=exports.createCMSSigned=exports.certificateRaw=exports.keyFromCertificateId=exports.listProviders=exports.listCertificates=exports.setPDFDocument=exports.updateArray=exports.removeFromArray=exports.parsePDF=exports.signpdfEmpty=undefined;var _pdfsign=require("./pdfsign.js");var _signutils=require("./signutils.js");exports.signpdfEmpty=_pdfsign.signpdfEmpty;exports.parsePDF=_pdfsign.parsePDF;exports.removeFromArray=_pdfsign.removeFromArray;exports.updateArray=_pdfsign.updateArray;exports.setPDFDocument=_pdfsign.setPDFDocument;exports.listCertificates=_signutils.listCertificates;exports.listProviders=_signutils.listProviders;exports.keyFromCertificateId=_signutils.keyFromCertificateId;exports.certificateRaw=_signutils.certificateRaw;exports.createCMSSigned=_signutils.createCMSSigned;exports.signpdf=_signutils.signpdf;exports.setEngine=_signutils.setEngine;exports.issuerCertificate=_signutils.issuerCertificate;exports.listSignatures=_signutils.listSignatures;exports.firstCertificate=_signutils.firstCertificate;exports.firstProvider=_signutils.firstProvider;exports.pdfHash=_signutils.pdfHash},{"./pdfsign.js":1,"./signutils.js":2}]},{},[])("pdfjs-firma")});
